<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:a4j="http://richfaces.org/a4j"
	xmlns:rich="http://richfaces.org/rich">

	<div class="section" lang="en-US">
	<div class="titlepage">
	<div>
	<div>
	<h2 class="title">Upload Images</h2>
	</div>
	</div>
	</div>
	<p>In the previous chapter we have discussed how to create
	Navigation Trees that represent "Shelves - Albums" hierarchy. Now it is
	time to upload images.</p>
	<p>The <span class="bold"><strong><span
		class="property">&lt;rich:fileUpload&gt;</span></strong></span> component in the Photo
	Album application uses the embedded Flash module that adds extra
	functionality to the component:</p>
	<div class="itemizedlist">
	<ul>
		<li>
		<p>Multiple files choosing;</p>
		</li>
		<li>
		<p>Definition of permitted file types in the "Open File" dialog
		window;</p>
		</li>
		<li>
		<p>A number of additional client side object properties.</p>
		</li>
	</ul>
	</div>
	<p>The code for the <span class="bold"><strong><span
		class="property">&lt;rich:fileUpload&gt;</span></strong></span> is contained in the
	"/includes/fileUpload/fileUploader.xhtml" page:</p>
	<pre  xml:space="preserve" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory"
		class="JAVA"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_plain">...</span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">rich:fileUpload</span><span
		class="xml_plain"></span><br />
<span class="xml_plain">        </span><span
		class="xml_attribute_name">allowFlash</span><span
		class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;true&quot;</span><span
		class="xml_plain"> </span><span class="xml_attribute_name">maxFilesQuantity</span><span
		class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;100&quot;</span><span
		class="xml_plain"> </span><span class="xml_attribute_name">autoclear</span><span
		class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;true&quot;</span><span
		class="xml_plain"></span><br />
<span class="xml_plain">        </span><span
		class="xml_attribute_name">fileUploadListener</span><span
		class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot; {fileUploadManager.listener}&quot;</span><span
		class="xml_plain"> </span><span class="xml_attribute_name">id</span><span
		class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;fileUpload&quot;</span><span
		class="xml_plain"></span><br />
<span class="xml_plain">        </span><span
		class="xml_attribute_name">disabled</span><span
		class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot; {model.selectedAlbum == null}&quot;</span><span
		class="xml_plain"></span><br />
<span class="xml_plain">        </span><span
		class="xml_attribute_name">immediateUpload</span><span
		class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;false&quot;</span><span
		class="xml_plain"> </span><span class="xml_attribute_name">acceptedTypes</span><span
		class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;jpg,jpeg&quot;</span><span
		class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">        </span><span
		class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">a4j:support</span><span
		class="xml_plain"> </span><span class="xml_attribute_name">event</span><span
		class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;onuploadcomplete&quot;</span><span
		class="xml_plain"> </span><span class="xml_attribute_name">reRender</span><span
		class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;filesPanel, treeform&quot;</span><span
		class="xml_plain"> </span><span class="xml_attribute_name">actionListener</span><span
		class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot; {fileWrapper.setComplete(true)}&quot;</span><span
		class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">        </span><span
		class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">a4j:support</span><span
		class="xml_plain"> </span><span class="xml_attribute_name">event</span><span
		class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;onfileuploadcomplete&quot;</span><span
		class="xml_plain"> </span><span class="xml_tag_symbols">/&gt;</span><span
		class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">rich:fileUpload</span><span
		class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">...</span><br />
</pre>
	<p>The <span class="emphasis"><em><span
		class="property">"allowFlash"</span></em></span> attribute set to "true" enables
	the Flash module.</p>
	<p>The <span class="emphasis"><em><span
		class="property">"acceptedTypes"</span></em></span> attribute specifies "jpg",
	"jpeg" as the permitted file types you can upload.</p>
	<p>The <span class="emphasis"><em><span
		class="property">"fileUploadListener"</span></em></span> attribute represents the
	action listener method <code class="code">listener()</code> of the <code
		class="code">FileUploadManager</code> class that is notified after
	file is uploaded. This method makes the main job on the upload:</p>
	<pre  xml:space="preserve" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory"
		class="JAVA"><!-- <br/> --><span class="java_separator">...</span>
<!--  --><br /><span class="java_plain">    </span><span
		class="java_keyword">public</span><span class="java_plain"> </span><span
		class="java_type">void</span><span class="java_plain"> listener</span><span
		class="java_separator">(</span><span class="java_type">UploadEvent</span><span
		class="java_plain"> event</span><span class="java_separator">)</span><span
		class="java_plain"> </span><span class="java_keyword">throws</span><span
		class="java_plain"> </span><span class="java_type">Exception</span><span
		class="java_plain"> </span><span class="java_separator">{</span>
<!--  --><br /><span class="java_plain">        </span><span
		class="java_type">UploadItem</span><span class="java_plain"> item </span><span
		class="java_operator">=</span><span class="java_plain"> event</span><span
		class="java_separator">.</span><span class="java_plain">getUploadItem</span><span
		class="java_separator">();</span>
<!--  --><br /><span class="java_plain">        </span><span
		class="java_type">Image</span><span class="java_plain"> image </span><span
		class="java_operator">=</span><span class="java_plain"> constructImage</span><span
		class="java_separator">(</span><span class="java_plain">item</span><span
		class="java_separator">);</span>
<!--  --><br /><span class="java_plain">        </span><span
		class="java_keyword">try</span><span class="java_plain"> </span><span
		class="java_separator">{</span>
<!--  --><br /><span class="java_plain">            extractMetadata</span><span
		class="java_separator">(</span><span class="java_plain">item</span><span
		class="java_separator">,</span><span class="java_plain"> image</span><span
		class="java_separator">);</span>
<!--  --><br /><span class="java_plain">        </span><span
		class="java_separator">}</span><span class="java_plain"> </span><span
		class="java_keyword">catch</span><span class="java_plain"> </span><span
		class="java_separator">(</span><span class="java_type">Exception</span><span
		class="java_plain"> e1</span><span class="java_separator">)</span><span
		class="java_plain"> </span><span class="java_separator">{</span>
<!--  --><br /><span class="java_plain">            addError</span><span
		class="java_separator">(</span><span class="java_plain">item</span><span
		class="java_separator">,</span><span class="java_plain"> image</span><span
		class="java_separator">,</span><span class="java_plain"> </span><span
		class="java_type">Constants</span><span class="java_separator">.</span><span
		class="java_plain">FILE_PROCESSING_ERROR</span><span
		class="java_separator">);</span>
<!--  --><br /><span class="java_plain">            </span><span
		class="java_keyword">return</span><span class="java_separator">;</span>
<!--  --><br /><span class="java_plain">        </span><span
		class="java_separator">}</span>
<!--  --><br /><span class="java_plain">        image</span><span
		class="java_separator">.</span><span class="java_plain">setAlbum</span><span
		class="java_separator">(</span><span class="java_plain">model</span><span
		class="java_separator">.</span><span class="java_plain">getSelectedAlbum</span><span
		class="java_separator">());</span>
<!--  --><br /><span class="java_plain">        </span><span
		class="java_keyword">if</span><span class="java_separator">(</span><span
		class="java_plain">image</span><span class="java_separator">.</span><span
		class="java_plain">getAlbum</span><span class="java_separator">()</span><span
		class="java_plain"> </span><span class="java_operator">==</span><span
		class="java_plain"> </span><span class="java_literal">null</span><span
		class="java_separator">){</span>
<!--  --><br /><span class="java_plain">            addError</span><span
		class="java_separator">(</span><span class="java_plain">item</span><span
		class="java_separator">,</span><span class="java_plain"> image</span><span
		class="java_separator">,</span><span class="java_plain"> </span><span
		class="java_type">Constants</span><span class="java_separator">.</span><span
		class="java_plain">NO_ALBUM_TO_DOWNLOAD_ERROR</span><span
		class="java_separator">);</span>
<!--  --><br /><span class="java_plain">            </span><span
		class="java_keyword">return</span><span class="java_separator">;</span>
<!--  --><br /><span class="java_plain">        </span><span
		class="java_separator">}</span>
<!--  --><br /><span class="java_plain">        </span><span
		class="java_keyword">try</span><span class="java_separator">{</span>
<!--  --><br /><span class="java_plain">            </span><span
		class="java_keyword">if</span><span class="java_separator">(</span><span
		class="java_plain">imageAction</span><span class="java_separator">.</span><span
		class="java_plain">isImageWithThisPathExist</span><span
		class="java_separator">(</span><span class="java_plain">image</span><span
		class="java_separator">)){</span>
<!--  --><br /><span class="java_plain">                image</span><span
		class="java_separator">.</span><span class="java_plain">setPath</span><span
		class="java_separator">(</span><span class="java_plain">generateNewPath</span><span
		class="java_separator">(</span><span class="java_plain">image</span><span
		class="java_separator">.</span><span class="java_plain">getPath</span><span
		class="java_separator">()));</span>
<!--  --><br /><span class="java_plain">            </span><span
		class="java_separator">}</span>
<!--  --><br /><span class="java_plain">            imageAction</span><span
		class="java_separator">.</span><span class="java_plain">addImage</span><span
		class="java_separator">(</span><span class="java_plain">image</span><span
		class="java_separator">);</span>
<!--  --><br /><span class="java_plain">        </span><span
		class="java_separator">}</span><span class="java_keyword">catch</span><span
		class="java_separator">(</span><span class="java_type">Exception</span><span
		class="java_plain"> e</span><span class="java_separator">){</span>
<!--  --><br /><span class="java_plain">            addError</span><span
		class="java_separator">(</span><span class="java_plain">item</span><span
		class="java_separator">,</span><span class="java_plain"> image</span><span
		class="java_separator">,</span><span class="java_plain"> </span><span
		class="java_type">Constants</span><span class="java_separator">.</span><span
		class="java_plain">IMAGE_SAVING_ERROR</span><span
		class="java_separator">);</span>
<!--  --><br /><span class="java_plain">            </span><span
		class="java_keyword">return</span><span class="java_separator">;</span>
<!--  --><br /><span class="java_plain">        </span><span
		class="java_separator">}</span>
<!--  --><br /><span class="java_plain">        </span><span
		class="java_keyword">if</span><span class="java_separator">(</span><span
		class="java_operator">!</span><span class="java_plain">fileManager</span><span
		class="java_separator">.</span><span class="java_plain">addImage</span><span
		class="java_separator">(</span><span class="java_plain">image</span><span
		class="java_separator">.</span><span class="java_plain">getFullPath</span><span
		class="java_separator">(),</span><span class="java_plain"> item</span><span
		class="java_separator">.</span><span class="java_plain">getFile</span><span
		class="java_separator">().</span><span class="java_plain">getPath</span><span
		class="java_separator">())){</span>
<!--  --><br /><span class="java_plain">            addError</span><span
		class="java_separator">(</span><span class="java_plain">item</span><span
		class="java_separator">,</span><span class="java_plain"> image</span><span
		class="java_separator">,</span><span class="java_plain"> </span><span
		class="java_type">Constants</span><span class="java_separator">.</span><span
		class="java_plain">FILE_SAVE_ERROR</span><span class="java_separator">);</span>
<!--  --><br /><span class="java_plain">            </span><span
		class="java_keyword">return</span><span class="java_separator">;</span>
<!--  --><br /><span class="java_plain">        </span><span
		class="java_separator">}</span>
<!--  --><br /><span class="java_plain">        fileWrapper</span><span
		class="java_separator">.</span><span class="java_plain">getFiles</span><span
		class="java_separator">().</span><span class="java_plain">add</span><span
		class="java_separator">(</span><span class="java_plain">image</span><span
		class="java_separator">);</span>
<!--  --><br /><span class="java_plain">        </span><span
		class="java_type">Events</span><span class="java_separator">.</span><span
		class="java_plain">instance</span><span class="java_separator">().</span><span
		class="java_plain">raiseEvent</span><span class="java_separator">(</span><span
		class="java_type">Constants</span><span class="java_separator">.</span><span
		class="java_plain">IMAGE_ADDED_EVENT</span><span
		class="java_separator">,</span><span class="java_plain"> image</span><span
		class="java_separator">);</span>
<!--  --><br /><span class="java_plain">        item</span><span
		class="java_separator">.</span><span class="java_plain">getFile</span><span
		class="java_separator">().</span><span class="java_plain">delete</span><span
		class="java_separator">();</span>
<!--  --><br /><span class="java_plain">    </span><span
		class="java_separator">}</span>
<!--  --><br /><span class="java_separator">...</span></pre>
	<p>The <code class="code">listener()</code> method is called at
	server side after every file uploaded and server saves these files in a
	temporary folder or in RAM depending on configuration. In the Photo
	Album application the uploaded files are stored in the temporary folder
	because the value of the <code class="code">createTempFile</code>
	parameter is set to <code class="code">true</code>. See the code from
	the <code class="code">web.xml</code> descriptor:</p>
	<pre  xml:space="preserve" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory"
		class="JAVA"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_plain">...</span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">filter</span><span
		class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">      </span><span
		class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">filter-name</span><span
		class="xml_tag_symbols">&gt;</span><span class="xml_plain">Seam Filter</span><span
		class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">filter-name</span><span
		class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">      </span><span
		class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">filter-class</span><span
		class="xml_tag_symbols">&gt;</span><span class="xml_plain">org.jboss.seam.servlet.SeamFilter</span><span
		class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">filter-class</span><span
		class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">      </span><span
		class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">init-param</span><span
		class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">            </span><span
		class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">param-name</span><span
		class="xml_tag_symbols">&gt;</span><span class="xml_plain">createTempFiles</span><span
		class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">param-name</span><span
		class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">            </span><span
		class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">param-value</span><span
		class="xml_tag_symbols">&gt;</span><span class="xml_plain">true</span><span
		class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">param-value</span><span
		class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">      </span><span
		class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">init-param</span><span
		class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">      </span><span
		class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">init-param</span><span
		class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">            </span><span
		class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">param-name</span><span
		class="xml_tag_symbols">&gt;</span><span class="xml_plain">maxRequestSize</span><span
		class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">param-name</span><span
		class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">            </span><span
		class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">param-value</span><span
		class="xml_tag_symbols">&gt;</span><span class="xml_plain">20000000</span><span
		class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">param-value</span><span
		class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">      </span><span
		class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">init-param</span><span
		class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">filter</span><span
		class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">...</span><br />
</pre>
	<p>The <code class="code">listener()</code> method creates an <code
		class="code">Image</code> object and extracts all image metadata such
	as Camera name, Image size, etc. It performs scaling of an image and
	saves six different image's dimentions in order to create thumbnails.
	After that the photo is added into the database the temporary file is
	removed.</p>
	<p>Vizit following pages at RichFaces Live Demo for more
	information, examples and sources on the components used in the
	application and described in this chapter:</p>
	<div class="itemizedlist">
	<ul>
		<li>
		<p><a target="_blank" xmlns:xlink="http://www.w3.org/1999/xlink"
			href="http://livedemo.exadel.com/richfaces-demo/richfaces/fileUpload.jsf?c=fileUpload">FileUpload</a>
		page for the <span class="bold"><strong><span
			class="property">&lt;rich:fileUpload&gt;</span></strong></span> component;</p>
		</li>
		<li>
		<p><a target="_blank" xmlns:xlink="http://www.w3.org/1999/xlink"
			href="http://livedemo.exadel.com/richfaces-demo/richfaces/support.jsf?c=support">AjaxSupport</a>
		for the <span class="bold"><strong><span
			class="property">&lt;a4j:suport&gt;</span></strong></span> component.</p>
		</li>
	</ul>
	</div>
	</div>

</ui:composition>